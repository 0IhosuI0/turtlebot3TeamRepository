# `qr_code_follower.py` 코드 리뷰 (Gemini 작성)

이 문서는 `qr_code_follower.py` 파일의 각 모듈과 함수들을 단계별로 설명합니다.

---

## 추적 방식: 하이브리드 추적 (QR 코드 + 색상)

이 로봇은 안정적인 대상 추적을 위해 **QR 코드**와 **색상 정보**를 함께 사용하는 **하이브리드 추적 방식**을 채택했습니다. 이 방식은 각 기술의 장점을 결합하여 추적의 안정성과 효율성을 극대화합니다.

**동작 원리:**

1.  **1단계: QR 코드로 타겟 초기화 (`IDLE` 상태)**
    *   로봇은 시야에 들어온 QR 코드를 인식하여 추적을 시작합니다.
    *   QR 코드 인식이 성공하면, YOLO 모델을 **단 한 번만** 사용하여 해당 QR 코드를 가진 사람의 위치(바운딩 박스)를 특정합니다.

2.  **2단계: 색상 프로필 추출**
    *   YOLO가 찾은 사람의 바운딩 박스 내에서, 옷 색상이 주로 분포하는 상반신 중앙 영역의 **색상 프로필(HSV 색상 공간의 히스토그램)**을 추출합니다. 이 프로필은 대상의 '색상 지문' 역할을 합니다.

3.  **3단계: 색상 기반 추적 (`FOLLOWING` 상태)**
    *   초기화가 끝나면, 로봇은 더 이상 YOLO를 사용하지 않고 가벼운 OpenCV의 **`meanShift` 알고리즘**으로 전환합니다.
    *   매 프레임마다 저장된 색상 프로필과 가장 일치하는 영역을 찾아내어 대상을 지속적으로 추적합니다. 이 방식은 QR 코드가 보이지 않거나 멀어져도 안정적인 추적을 가능하게 합니다.

4.  **4단계: 타겟 유실 및 재탐색 (`SEARCHING` 상태)**
    *   색상 추적마저 실패하면, 로봇은 제자리에서 회전하며 대상을 다시 찾습니다.
    *   탐색 중 원래의 QR 코드를 다시 발견하면, 1단계부터 다시 시작하여 추적을 재개합니다.

이 하이브리드 방식을 통해, 로봇은 QR 코드로 명확하게 추적을 시작하고, 이후에는 가볍고 빠른 색상 추적으로 전환하여 시스템 부하를 줄이고 추적의 연속성을 보장합니다.

---

### `qr_code_follower.py` 파일 구조 및 주요 모듈/함수 설명

**1. `QRCodeFollower` 클래스 (메인 모듈)**

이 클래스는 ROS 노드로서, 로봇의 동작을 제어하는 모든 로직을 포함합니다.

*   **`__init__(self)` 함수:**
    *   **역할:** `QRCodeFollower` 노드를 초기화하고 필요한 통신 채널, 모델, 상태 변수 등을 설정합니다.
    *   **세부 설명:**
        *   ROS 통신 설정 (Publisher/Subscriber)은 이전과 동일합니다.
        *   **YOLO 모델 로드:** `self.model = YOLO('yolov8n.pt')`를 사용하여 YOLOv8n 모델을 로드합니다. 이 모델은 이제 **최초 대상 식별 시에만** 사용됩니다.
        *   **상태 관리 변수 초기화:**
            *   `self.robot_state`: 로봇의 현재 상태 (`IDLE`, `FOLLOWING`, `SEARCHING`).
            *   `self.locked_target_id`: 추적 대상의 ID.
            *   `self.tracking_mode`: 현재 추적 방식을 나타냅니다 (`YOLO` 또는 `COLOR`).
            *   `self.target_hist`: 대상의 색상 프로필(히스토그램)을 저장합니다.
            *   `self.track_window`: `meanShift` 알고리즘이 사용하는 추적 창의 위치와 크기를 저장합니다.
        *   장애물 회피 및 탐색 관련 변수 초기화는 이전과 동일합니다.

*   **`scan_callback(self, msg)` 함수:**
    *   **역할:** LiDAR 스캔 데이터를 처리하여 로봇 주변의 장애물 정보를 업데이트합니다. (이전과 동일)

*   **`image_callback(self, msg)` 함수:**
    *   **역할:** 카메라 이미지를 처리하고, 상태에 따라 타겟을 식별, 추적, 탐색하는 **핵심 로직**을 수행합니다.
    *   **세부 설명:**
        *   **`IDLE` 상태:**
            *   QR 코드를 찾습니다.
            *   QR 코드를 찾으면 YOLO를 호출하여 해당 QR을 가진 사람을 찾고, `initialize_color_tracker` 함수를 호출하여 색상 프로필을 추출합니다.
            *   성공적으로 프로필이 추출되면, 로봇 상태를 `FOLLOWING`으로, `tracking_mode`를 `COLOR`로 변경합니다.
        *   **`FOLLOWING` 상태:**
            *   `tracking_mode`가 `COLOR`이면, `cv2.calcBackProject`와 `cv2.meanShift`를 사용하여 저장된 `target_hist`를 기반으로 대상의 현재 위치(`track_window`)를 찾습니다.
            *   추적에 성공하면, `generate_motion_command`를 호출하여 로봇을 움직입니다.
            *   추적에 실패하면, 로봇 상태를 `SEARCHING`으로 변경합니다.
        *   **`SEARCHING` 상태:**
            *   `get_searching_twist`를 호출하여 탐색 동작을 수행합니다.
            *   탐색 중에 원래 추적하던 대상의 QR 코드가 다시 보이면, `IDLE` 상태로 돌아가 추적을 다시 초기화할 준비를 합니다.
        *   **시각화:** 현재 추적 중인 대상을 사각형으로 표시하고 화면에 출력합니다.

*   **`initialize_color_tracker(self, frame, hsv, person_box)` 함수 (신규):**
    *   **역할:** 추적할 대상의 색상 프로필(히스토그램)을 생성하고 초기 추적 창을 설정합니다.
    *   **세부 설명:**
        *   YOLO가 감지한 사람의 바운딩 박스(`person_box`) 내에서 상반신 중앙 부분을 ROI(관심 영역)로 설정합니다.
        *   ROI를 HSV 색상 공간으로 변환하고, 너무 어둡거나 밝은 픽셀을 제외하기 위한 마스크를 생성합니다.
        *   `cv2.calcHist`를 사용하여 ROI의 색상 히스토그램을 계산하고, `self.target_hist`에 저장합니다.
        *   `self.track_window`를 ROI의 위치와 크기로 초기화합니다.

*   **`generate_motion_command(self, target_box, frame_width)` 함수:**
    *   **역할:** 로봇의 최종 동작 명령을 생성합니다. 장애물 회피 로직은 이전과 동일하며, 주행 로직은 `get_following_twist`를 호출합니다.
    *   **세부 설명:**
        *   장애물 회피 로직은 최우선으로 동작합니다.
        *   `FOLLOWING` 상태일 경우, `get_following_twist` 함수를 호출하여 대상 추적을 위한 속도 명령을 생성합니다. 이 함수는 이제 `meanShift`가 반환하는 추적 창 `(x, y, w, h)`을 처리할 수 있도록 수정되었습니다.

*   **`get_following_twist(self, target_window, frame_width)` 함수:**
    *   **역할:** `FOLLOWING` 상태일 때 대상을 따라가는 속도 명령을 계산합니다.
    *   **세부 설명:**
        *   입력으로 `target_window`(`x, y, w, h` 형식)를 받습니다.
        *   추적 창의 중심과 이미지 중심 간의 오차를 이용해 회전 속도를 계산합니다.
        *   추적 창의 면적(`w * h`)을 이용해 대상과의 거리를 추정하고 전진/후진 속도를 결정합니다.

*   **`get_searching_twist(self)` 함수:**
    *   **역할:** `SEARCHING` 상태일 때 대상을 탐색하는 속도 명령을 계산합니다. (이전과 동일)

*   **`save_user_profile(self, user_data)` 함수:**
    *   **역할:** 인식된 사용자 프로필 데이터를 JSON 파일로 저장합니다. (이전과 동일)

---

**2. `main(args=None)` 함수 및 `if __name__ == '__main__':` 블록:**

*   **역할:** ROS 노드를 실행하는 진입점입니다. (이전과 동일)

---

요약하자면, `qr_code_follower.py`는 이제 **QR 코드를 이용한 명시적인 타겟 지정**과 **색상 히스토그램을 이용한 강인한 추적**을 결합한 하이브리드 시스템으로 발전했습니다. 이를 통해 실제 환경에서 발생할 수 있는 다양한 변수(가려짐, 거리 변화 등)에 더 효과적으로 대응할 수 있습니다.
